{% load tools_extras %}
{# Stack Card Partial - Include with: stack, show_visibility (optional), compact (optional) #}
{# Usage: {% include 'includes/_stack_card.html' with stack=stack %} #}

<div class="relative h-full group">
    <a href="{% url 'stack_detail' stack.slug %}" class="stack-card group block h-full">
        {# Header: Icon, Badges #}
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-lg bg-brand-100 flex items-center justify-center group-hover:bg-brand-600 transition-colors shadow-sm">
                    <svg class="w-6 h-6 text-brand-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </div>
                <span class="neon-badge neon-badge-cyan">{{ stack.tools.count }} Tools</span>
            </div>
            <div class="flex items-center gap-2">
                {% if show_visibility and stack.visibility %}
                <span class="px-2 py-1 rounded text-xs font-bold {% if stack.visibility == 'public' %}bg-green-100 text-green-700{% else %}bg-slate-100 text-slate-600{% endif %}">
                    {{ stack.get_visibility_display }}
                </span>
                {% endif %}
                {% if stack.is_featured %}
                {% include 'includes/_featured_badge.html' %}
                {% endif %}
            </div>
        </div>

        {# Title & Description #}
        <h3 class="font-heading font-bold text-xl text-slate-900 mb-1 group-hover:text-brand-600 transition-colors">{{ stack.name }}</h3>
        <p class="text-slate-600 mb-3 line-clamp-3 text-sm">{{ stack.tagline }}</p>

        {# Tool Avatars Preview #}
        {% if not compact %}
        <div class="flex items-center gap-2 mb-3">
            <div class="flex -space-x-3">
                {% for tool in stack.tools.all|slice:":4" %}
                {% if tool.logo %}
                <img src="{{ tool.logo.url }}" alt="{{ tool.name }}" loading="lazy" width="32" height="32" class="w-8 h-8 rounded-md border-2 border-white object-cover shadow-sm">
                {% else %}
                <div class="w-8 h-8 rounded-md border-2 border-white bg-gradient-to-br from-brand-500 to-brand-600 flex items-center justify-center text-white font-heading font-bold text-xs shadow-sm">
                    {{ tool.name|slice:":2"|upper }}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% if stack.tools.count > 4 %}
            <span class="text-sm text-slate-500 font-medium">+{{ stack.tools.count|add:"-4" }} more</span>
            {% endif %}
        </div>
        {% endif %}

        {# Professions Tags #}
        {% if stack.professions.exists and not compact %}
        <div class="flex flex-wrap gap-1.5 mb-3">
            {% for profession in stack.professions.all|slice:":3" %}
            <span class="text-xs font-semibold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded">{{ profession.name }}</span>
            {% endfor %}
        </div>
        {% endif %}

        {# Owner (if community stack) #}
        {% if stack.owner %}
        <div class="flex items-center gap-2 mb-3 text-sm text-slate-500">
            <i class="fa-solid fa-user text-xs"></i>
            <span>Custom</span>
        </div>
        {% endif %}

        {# Footer: Explore Link #}
        <div class="mt-auto pt-3 border-t border-slate-100 flex items-center justify-between">
            <span class="text-brand-600 font-semibold flex items-center gap-2 group-hover:gap-3 transition-all">
                Explore Stack
                <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
            </span>
            {% if show_created_at and stack.created_at %}
            <span class="text-xs text-slate-400">{{ stack.created_at|timesince }} ago</span>
            {% endif %}
        </div>
    </a>

    {# Favorite Button (Absolute - Bottom Right) #}
    {# Favorite Button (Absolute - Bottom Right) #}
    {% if request.user != stack.owner %}
    <div class="absolute bottom-4 right-4 z-10">
        {% if request.user.is_authenticated %}
        <button onclick="toggleStackSave(event, '{{ stack.slug }}', this)"
                class="w-10 h-10 rounded-full bg-white/90 backdrop-blur-sm shadow-sm flex items-center justify-center transition-colors group/btn"
                title="{% if stack|is_saved_by:request.user %}Remove from favorites{% else %}Add to favorites{% endif %}">
            <i class="fa-solid fa-heart text-lg transition-colors {% if stack|is_saved_by:request.user %}text-red-500{% else %}text-slate-300 group-hover/btn:text-red-500{% endif %}" id="stack-heart-{{ stack.slug }}"></i>
        </button>
        {% else %}
        <a href="{% url 'account_signup' %}"
           class="w-10 h-10 rounded-full bg-white/90 backdrop-blur-sm shadow-sm flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-white transition-colors"
           onclick="event.stopPropagation();"
           title="Sign up to save stacks">
            <i class="fa-regular fa-heart text-lg"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>