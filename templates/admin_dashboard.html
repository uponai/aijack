{% extends 'base.html' %}

{% block title %}Admin Analytics Dashboard | AIJACK{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 relative z-10">

    <!-- Admin Navigation -->
    {% include 'partials/admin_nav.html' %}

    <!-- Header -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-12">
        <div>
            <h1 class="text-3xl font-heading font-black text-slate-800">
                Analytics Dashboard
            </h1>
        </div>

        <!-- Time Period Selector -->
        <div class="flex items-center gap-3">
            <span class="text-slate-500 font-semibold">Period:</span>
            <div class="flex gap-2">
                <a href="?days=7" class="px-4 py-2 rounded-lg font-heading text-sm {% if days == 7 %}bg-brand-600 text-white{% else %}bg-white/80 text-slate-600 hover:bg-brand-50{% endif %} transition">7 Days</a>
                <a href="?days=30" class="px-4 py-2 rounded-lg font-heading text-sm {% if days == 30 %}bg-brand-600 text-white{% else %}bg-white/80 text-slate-600 hover:bg-brand-50{% endif %} transition">30 Days</a>
                <a href="?days=90" class="px-4 py-2 rounded-lg font-heading text-sm {% if days == 90 %}bg-brand-600 text-white{% else %}bg-white/80 text-slate-600 hover:bg-brand-50{% endif %} transition">90 Days</a>
            </div>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
        <!-- Total Searches -->
        <div class="neon-card p-6 text-center">
            <div class="text-4xl font-heading font-black text-brand-600 mb-2">{{ search_stats.total_searches|default:"0" }}</div>
            <div class="text-slate-600 font-semibold uppercase text-sm tracking-wider">Total Searches</div>
            <div class="mt-2 text-xs text-slate-400">{{ search_stats.unique_queries|default:"0" }} unique queries</div>
        </div>

        <!-- Total Clicks -->
        <div class="neon-card p-6 text-center">
            <div class="text-4xl font-heading font-black text-green-500 mb-2">{{ click_stats.total_clicks|default:"0" }}</div>
            <div class="text-slate-600 font-semibold uppercase text-sm tracking-wider">Tool Clicks</div>
            <div class="mt-2 text-xs text-slate-400">{{ click_stats.unique_tools|default:"0" }} unique tools</div>
        </div>

        <!-- Conversions -->
        <div class="neon-card p-6 text-center">
            <div class="text-4xl font-heading font-black text-purple-500 mb-2">{{ click_stats.conversions|default:"0" }}</div>
            <div class="text-slate-600 font-semibold uppercase text-sm tracking-wider">Conversions</div>
            <div class="mt-2 text-xs text-slate-400">From affiliate links</div>
        </div>

        <!-- Revenue -->
        <div class="neon-card p-6 text-center">
            <div class="text-4xl font-heading font-black text-yellow-500 mb-2">${{ click_stats.total_revenue|default:"0" }}</div>
            <div class="text-slate-600 font-semibold uppercase text-sm tracking-wider">Revenue</div>
            <div class="mt-2 text-xs text-slate-400">Tracked conversions</div>
        </div>
    </div>

    <!-- Unresolved Reports -->
    <div class="neon-card p-8 mt-8 border-l-4 border-red-500">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-heading font-bold text-brand-600">
                <i class="fa-solid fa-flag text-red-500 mr-2"></i>Unresolved Reports
            </h2>
            <div class="flex items-center gap-4">
                <a href="/admin/tools/toolreport/?is_resolved__exact=0" class="text-sm font-semibold text-brand-600 hover:text-brand-700 hover:underline">
                    View All
                </a>
                <span class="text-sm text-slate-500">
                    Total: <strong class="text-red-600">{{ total_unresolved_reports }}</strong>
                </span>
            </div>
        </div>

        {% if unresolved_reports %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-brand-200">
                        <th class="text-left py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Tool</th>
                        <th class="text-left py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Reason</th>
                        <th class="text-left py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Message</th>
                        <th class="text-right py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Date</th>
                        <th class="text-right py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-brand-100">
                    {% for report in unresolved_reports %}
                    <tr class="hover:bg-slate-50 transition">
                        <td class="py-3 px-4">
                            <a href="{% url 'tool_detail' report.tool.slug %}" class="font-bold text-slate-800 hover:text-brand-600" target="_blank">{{ report.tool.name }}</a>
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs font-bold uppercase tracking-wider 
                                {% if report.reason == 'broken_link' %}bg-red-100 text-red-700{% elif report.reason == 'outdated' %}bg-yellow-100 text-yellow-700{% else %}bg-slate-100 text-slate-700{% endif %}">
                                {{ report.get_reason_display }}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-slate-600 text-sm max-w-xs truncate">{{ report.message|default:"-" }}</td>
                        <td class="py-3 px-4 text-right text-slate-500 text-sm">{{ report.created_at|date:"M d, Y" }}</td>
                        <td class="py-3 px-4 text-right">
                            <a href="/admin/tools/toolreport/{{ report.id }}/change/" class="text-brand-600 hover:text-brand-800 font-semibold text-sm">
                                Review <i class="fa-solid fa-arrow-right ml-1"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-slate-400">
            <i class="fa-solid fa-check-circle text-4xl mb-4 text-green-500 opacity-50"></i>
            <p>No unresolved reports! Great job.</p>
        </div>
        {% endif %}
    </div>

    <!-- Newsletter Subscribers -->
    <div class="neon-card p-8 mt-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-heading font-bold text-brand-600">
                <i class="fa-solid fa-envelope text-pink-500 mr-2"></i>Newsletter Subscribers
            </h2>
            <div class="flex items-center gap-4">
                <!-- Search Input -->
                <div class="relative">
                    <input type="search"
                           name="q_sub"
                           placeholder="Search emails..."
                           value="{{ q_sub }}"
                           class="pl-10 pr-4 py-2 rounded-lg border border-slate-200 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 text-sm"
                           hx-get="{% url 'admin_dashboard' %}?days={{ days }}"
                           hx-trigger="keyup changed delay:500ms, search"
                           hx-target="#newsletter-rows"
                           hx-indicator="#newsletter-spinner">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <div id="newsletter-spinner" class="htmx-indicator absolute right-3 top-1/2 -translate-y-1/2">
                        <i class="fa-solid fa-spinner fa-spin text-brand-600"></i>
                    </div>
                </div>

                <span class="text-sm text-slate-500">
                    Total: <strong class="text-brand-600">{{ newsletter_total }}</strong>
                </span>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-brand-200">
                        <th class="text-left py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Email</th>
                        <th class="text-center py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Status</th>
                        <th class="text-right py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Subscribed Date</th>
                    </tr>
                </thead>
                <tbody id="newsletter-rows" class="divide-y divide-brand-100">
                    {% include 'partials/newsletter_rows.html' with subscribers=newsletter_subscribers has_more=newsletter_has_more next_page=newsletter_next_page q_sub=q_sub days=days %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls (Managed via Row) -->
    </div>

    <!-- Main Content Grid (4 columns now with Robots) -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-8">

        <!-- Column 1: Tools Analytics -->
        <div class="space-y-6">
            <h3 class="font-heading font-bold text-slate-800 text-lg border-b border-slate-200 pb-2">
                <i class="fa-solid fa-cube text-blue-500 mr-2"></i>Tools
            </h3>

            <!-- Viewed Tools -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Most Viewed</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-blue-50 text-blue-600 font-bold border border-blue-100">{{ days }}d</span>
                </div>
                {% if top_viewed_tools %}
                <div class="space-y-1">
                    {% for tool in top_viewed_tools %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        {% if tool.logo %}
                        <img src="{{ tool.logo.url }}" alt="{{ tool.name }}" class="w-6 h-6 rounded object-cover border border-slate-200">
                        {% else %}
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                            <i class="fa-solid fa-cube text-white text-[8px]"></i>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'tool_detail' tool.slug %}" class="font-bold text-slate-700 text-xs hover:text-blue-600 truncate block">{{ tool.name }}</a>
                        </div>
                        <div class="font-bold text-blue-600 text-xs">{{ tool.view_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>

            <!-- Clicked Tools -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Best Converting</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-orange-50 text-orange-600 font-bold border border-orange-100">{{ days }}d</span>
                </div>
                {% if top_clicked_tools %}
                <div class="space-y-1">
                    {% for tool in top_clicked_tools %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        {% if tool.logo %}
                        <img src="{{ tool.logo.url }}" alt="{{ tool.name }}" class="w-6 h-6 rounded object-cover border border-slate-200">
                        {% else %}
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center">
                            <i class="fa-solid fa-fire text-white text-[8px]"></i>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'tool_detail' tool.slug %}" class="font-bold text-slate-700 text-xs hover:text-orange-600 truncate block">{{ tool.name }}</a>
                        </div>
                        <div class="font-bold text-orange-600 text-xs">{{ tool.click_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>
        </div>

        <!-- Column 2: Stacks Analytics -->
        <div class="space-y-6">
            <h3 class="font-heading font-bold text-slate-800 text-lg border-b border-slate-200 pb-2">
                <i class="fa-solid fa-layer-group text-purple-500 mr-2"></i>Stacks
            </h3>

            <!-- Viewed Stacks -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Most Viewed</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-purple-50 text-purple-600 font-bold border border-purple-100">{{ days }}d</span>
                </div>
                {% if top_stacks %}
                <div class="space-y-1">
                    {% for stack in top_stacks %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
                            <i class="fa-solid fa-boxes-stacked text-white text-[8px]"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'stack_detail' stack.slug %}" class="font-bold text-slate-700 text-xs hover:text-purple-600 truncate block">{{ stack.name }}</a>
                        </div>
                        <div class="font-bold text-purple-600 text-xs">{{ stack.view_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>

            <!-- Clicked Stacks -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Best Converting</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-pink-50 text-pink-600 font-bold border border-pink-100">{{ days }}d</span>
                </div>
                {% if top_clicked_stacks %}
                <div class="space-y-1">
                    {% for stack in top_clicked_stacks %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-pink-400 to-pink-600 flex items-center justify-center">
                            <i class="fa-solid fa-trophy text-white text-[8px]"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'stack_detail' stack.slug %}" class="font-bold text-slate-700 text-xs hover:text-pink-600 truncate block">{{ stack.name }}</a>
                        </div>
                        <div class="font-bold text-pink-600 text-xs">{{ stack.click_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>
        </div>

        <!-- Column 3: Robots Analytics -->
        <div class="space-y-6">
            <h3 class="font-heading font-bold text-slate-800 text-lg border-b border-slate-200 pb-2">
                <i class="fa-solid fa-robot text-cyan-600 mr-2"></i>Robots
            </h3>

            <!-- Viewed Robots -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Most Viewed</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-cyan-50 text-cyan-600 font-bold border border-cyan-100">{{ days }}d</span>
                </div>
                {% if top_viewed_robots %}
                <div class="space-y-1">
                    {% for robot in top_viewed_robots %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        {% if robot.robot__image %}
                        <img src="{{ robot.robot__image }}" alt="{{ robot.robot__name }}" class="w-6 h-6 rounded object-cover border border-slate-200">
                        {% else %}
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center">
                            <i class="fa-solid fa-robot text-white text-[8px]"></i>
                        </div>
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'robot_detail' robot.robot__slug %}" class="font-bold text-slate-700 text-xs hover:text-cyan-600 truncate block">{{ robot.robot__name }}</a>
                        </div>
                        <div class="font-bold text-cyan-600 text-xs">{{ robot.view_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>
        </div>

        <!-- Column 4: Professions Analytics -->
        <div class="space-y-6">
            <h3 class="font-heading font-bold text-slate-800 text-lg border-b border-slate-200 pb-2">
                <i class="fa-solid fa-briefcase text-teal-500 mr-2"></i>Professions
            </h3>

            <!-- Viewed Professions -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Most Viewed</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-teal-50 text-teal-600 font-bold border border-teal-100">{{ days }}d</span>
                </div>
                {% if top_professions %}
                <div class="space-y-1">
                    {% for prof in top_professions %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
                            <i class="fa-solid fa-user-tie text-white text-[8px]"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'profession_detail' prof.slug %}" class="font-bold text-slate-700 text-xs hover:text-teal-600 truncate block">{{ prof.name }}</a>
                        </div>
                        <div class="font-bold text-teal-600 text-xs">{{ prof.view_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>

            <!-- Clicked Professions -->
            <div class="neon-card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-wide">Best Converting</h2>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-indigo-50 text-indigo-600 font-bold border border-indigo-100">{{ days }}d</span>
                </div>
                {% if top_clicked_professions %}
                <div class="space-y-1">
                    {% for prof in top_clicked_professions %}
                    <div class="flex items-center gap-3 p-1.5 rounded hover:bg-slate-50 transition group">
                        <div class="font-mono text-xs font-bold text-slate-400 w-4">{{ forloop.counter }}</div>
                        <div class="w-6 h-6 rounded bg-gradient-to-br from-indigo-400 to-indigo-600 flex items-center justify-center">
                            <i class="fa-solid fa-star text-white text-[8px]"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'profession_detail' prof.slug %}" class="font-bold text-slate-700 text-xs hover:text-indigo-600 truncate block">{{ prof.name }}</a>
                        </div>
                        <div class="font-bold text-indigo-600 text-xs">{{ prof.click_count }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-xs text-slate-400 text-center py-4">No data.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- Recent Searches Table -->
    <div class="neon-card p-8 mt-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-heading font-bold text-brand-600">
                <i class="fa-solid fa-magnifying-glass text-cyan-500 mr-2"></i>Recent Search Queries
            </h2>
            <div class="flex items-center gap-4">
                <span class="text-sm text-slate-500">
                    Avg results: <strong class="text-brand-600">{{ search_stats.avg_results|floatformat:1|default:"0" }}</strong>
                </span>
                <span class="neon-badge-cyan">Last {{ days }} days</span>
            </div>
        </div>

        {% if recent_searches %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-brand-200">
                        <th class="text-left py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Query</th>
                        <th class="text-center py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Results</th>
                        <th class="text-center py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Source</th>
                        <th class="text-center py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">User</th>
                        <th class="text-right py-3 px-4 font-heading text-brand-600 uppercase text-sm tracking-wider">Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% include 'partials/search_rows.html' %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12 text-slate-400">
            <i class="fa-solid fa-magnifying-glass text-4xl mb-4 opacity-50"></i>
            <p>No search queries yet. Queries will appear here once users start searching.</p>
        </div>
        {% endif %}
    </div>

    <!-- Quick Link back to Admin -->
    <div class="mt-8 text-center">
        <a href="/admin/" class="neon-button-cyan">
            <i class="fa-solid fa-arrow-left mr-2"></i> Back to Django Admin
        </a>
    </div>

</div>
{% endblock %}