{% extends 'base.html' %}

{% block title %}Notification Manager | AIJACK Admin{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 relative z-10"
     x-data="notificationManager()">

    <!-- Admin Navigation -->
    {% include 'partials/admin_nav.html' %}

    <!-- Header -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-heading font-black text-slate-800">
                Notification Manager
            </h1>
            <p class="text-slate-500 mt-1">Manage site-wide announcements and popups</p>
        </div>
        <div>
            <button @click="openModal()" class="neon-button-cyan">
                <i class="fa-solid fa-plus mr-2"></i>New Notification
            </button>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="neon-card overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="bg-slate-50 border-b border-slate-200">
                    <th class="text-left py-4 px-4 font-heading text-slate-600 uppercase text-xs tracking-wider w-1/3">Notification</th>
                    <th class="text-left py-4 px-4 font-heading text-slate-600 uppercase text-xs tracking-wider">Content / Video</th>
                    <th class="text-center py-4 px-4 font-heading text-slate-600 uppercase text-xs tracking-wider w-20">Priority</th>
                    <th class="text-right py-4 px-4 font-heading text-slate-600 uppercase text-xs tracking-wider w-24">Active</th>
                    <th class="text-right py-4 px-4 font-heading text-slate-600 uppercase text-xs tracking-wider w-24">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100" hx-boost="true">
                {% for n in notifications %}
                {% include 'partials/_admin_notification_row.html' %}
                {% empty %}
                <tr>
                    <td colspan="5" class="py-8 text-center text-slate-500 italic">
                        No notifications found. Create one to get started.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Create/Edit Modal -->
    <div x-show="showModal" x-cloak class="relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div x-show="showModal"
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm transition-opacity" @click="closeModal()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div x-show="showModal"
                     x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     class="relative transform rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-brand-100">

                    <form method="POST" @submit.prevent="submitForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" :value="isEditing ? 'update' : 'create'">
                        <input type="hidden" name="notification_id" x-model="form.id">

                        <!-- Header -->
                        <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                            <h3 class="text-lg font-heading font-bold text-slate-800" x-text="isEditing ? 'Edit Notification' : 'New Notification'"></h3>
                            <button type="button" @click="closeModal()" class="text-slate-400 hover:text-slate-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                        </div>

                        <!-- Body -->
                        <div class="px-6 py-6 space-y-6">

                            <!-- Title & Type -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Title</label>
                                    <input type="text" name="title" x-model="form.title" class="w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Type</label>
                                    <select name="notification_type" x-model="form.notification_type" class="w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500">
                                        <option value="news">News / Announcement</option>
                                        <option value="permanent">Permanent / Important</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Tabs: Text vs Video -->
                            <div class="border-b border-slate-200">
                                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                    <button type="button" @click="activeTab = 'text'"
                                            :class="activeTab === 'text' ? 'border-brand-500 text-brand-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                                        <i class="fa-solid fa-align-left mr-2"></i>Content Editor
                                    </button>
                                    <button type="button" @click="activeTab = 'video'"
                                            :class="activeTab === 'video' ? 'border-brand-500 text-brand-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                                        <i class="fa-brands fa-youtube mr-2"></i>YouTube Video
                                    </button>
                                </nav>
                            </div>

                            <!-- Text Editor -->
                            <div x-show="activeTab === 'text'" class="animate-fadeIn">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Message Content</label>
                                <div class="border border-slate-300 rounded-lg overflow-hidden bg-white shadow-sm focus-within:ring-1 focus-within:ring-brand-500 focus-within:border-brand-500">
                                    <!-- Toolbar -->
                                    <div class="bg-slate-50 border-b border-slate-200 px-2 py-1 flex gap-1">
                                        <button type="button" @click="execCmd('formatBlock', 'H3')" class="p-2 text-slate-600 hover:bg-slate-200 rounded" title="Heading">
                                            <i class="fa-solid fa-heading"></i>
                                        </button>
                                        <button type="button" @click="execCmd('bold')" class="p-2 text-slate-600 hover:bg-slate-200 rounded" title="Bold">
                                            <i class="fa-solid fa-bold"></i>
                                        </button>
                                        <button type="button" @click="execCmd('insertUnorderedList')" class="p-2 text-slate-600 hover:bg-slate-200 rounded" title="List">
                                            <i class="fa-solid fa-list-ul"></i>
                                        </button>
                                        <div class="w-px h-6 bg-slate-300 mx-1 self-center"></div>
                                        <button type="button" @click="execCmd('createLink', prompt('Enter link URL:', 'https://'))" class="p-2 text-slate-600 hover:bg-slate-200 rounded" title="Link">
                                            <i class="fa-solid fa-link"></i>
                                        </button>
                                        <button type="button" @click="execCmd('unlink')" class="p-2 text-slate-600 hover:bg-slate-200 rounded" title="Unlink">
                                            <i class="fa-solid fa-unlink"></i>
                                        </button>
                                    </div>
                                    <!-- Editable Area -->
                                    <div id="editor-content"
                                         contenteditable="true"
                                         class="p-4 min-h-[150px] outline-none prose prose-sm max-w-none"
                                         @input="form.content = $el.innerHTML"
                                         x-ref="editor"></div>
                                </div>
                                <input type="hidden" name="content" x-model="form.content">
                                <p class="text-xs text-slate-400 mt-1">Use the toolbar to format your message. Keep it concise.</p>
                            </div>

                            <!-- Video Input -->
                            <div x-show="activeTab === 'video'" class="animate-fadeIn">
                                <label class="block text-sm font-bold text-slate-700 mb-2">YouTube URL</label>
                                <input type="url" name="youtube_url" x-model="form.youtube_url"
                                       placeholder="https://www.youtube.com/watch?v=..."
                                       class="w-full rounded-lg border-slate-200 focus:border-brand-500 focus:ring-brand-500">

                                <!-- Preview -->
                                <div x-show="youtubeId" class="mt-4 rounded-xl overflow-hidden shadow-lg border border-slate-200 bg-slate-100 aspect-video relative">
                                    <iframe :src="'https://www.youtube.com/embed/' + youtubeId + '?rel=0&modestbranding=1&playsinline=1&origin=' + window.location.origin"
                                            class="absolute inset-0 w-full h-full"
                                            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                                <p class="text-xs text-slate-400 mt-1" x-show="!youtubeId">Paste a YouTube URL to see a preview.</p>
                            </div>

                            <!-- Options -->
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Priority</label>
                                    <input type="number" name="priority" x-model="form.priority" class="w-full rounded-lg border-slate-200 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Visibility</label>
                                    <select name="visibility" x-model="form.visibility" class="w-full rounded-lg border-slate-200 text-sm">
                                        <option value="public">Public</option>
                                        <option value="auth_only">Auth Only</option>
                                    </select>
                                </div>
                                <div class="flex items-center pt-6">
                                    <label class="flex items-center cursor-pointer">
                                        <span class="mr-3 text-sm font-bold text-slate-700">Active</span>
                                        <div class="relative">
                                            <input type="checkbox" name="is_active" class="sr-only" x-model="form.is_active">
                                            <div class="block bg-slate-200 w-10 h-6 rounded-full transition-colors" :class="form.is_active ? 'bg-brand-600' : 'bg-slate-200'"></div>
                                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform" :class="form.is_active ? 'translate-x-4' : ''"></div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                        </div>

                        <!-- Footer -->
                        <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-3 rounded-b-2xl">
                            <button type="button" @click="closeModal()" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-semibold transition">Cancel</button>
                            <button type="submit" class="neon-button-cyan">
                                <span x-text="isEditing ? 'Update Notification' : 'Create Notification'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function notificationManager ()
    {
        return {
            showModal: false,
            isEditing: false,
            activeTab: 'text',
            form: {
                id: '',
                title: '',
                content: '',
                youtube_url: '',
                notification_type: 'news',
                visibility: 'public',
                priority: 0,
                is_active: true
            },

            get youtubeId ()
            {
                if ( !this.form.youtube_url ) return null;
                const url = this.form.youtube_url;
                if ( url.includes( 'v=' ) ) return url.split( 'v=' )[ 1 ].split( '&' )[ 0 ];
                if ( url.includes( 'youtu.be/' ) ) return url.split( 'youtu.be/' )[ 1 ].split( '?' )[ 0 ];
                return null;
            },

            execCmd ( command, value = null )
            {
                document.execCommand( command, false, value );
                // Trigger input event to update x-model
                this.$refs.editor.dispatchEvent( new Event( 'input', { bubbles: true } ) );
            },

            openModal ()
            {
                this.resetForm();
                this.showModal = true;
                this.activeTab = 'text';
                setTimeout( () =>
                {
                    this.$refs.editor.innerHTML = '';
                }, 50 );
            },

            closeModal ()
            {
                this.showModal = false;
            },

            editNotification ( id, title, content, youtube_url, type, visibility, priority, is_active )
            {
                this.form = {
                    id: id,
                    title: title,
                    content: content,
                    youtube_url: youtube_url,
                    notification_type: type,
                    visibility: visibility,
                    priority: priority,
                    is_active: is_active
                };
                this.isEditing = true;
                this.showModal = true;

                if ( youtube_url )
                {
                    this.activeTab = 'video';
                } else
                {
                    this.activeTab = 'text';
                }

                // Set editor content
                setTimeout( () =>
                {
                    this.$refs.editor.innerHTML = content;
                }, 50 );
            },

            resetForm ()
            {
                this.isEditing = false;
                this.form = {
                    id: '',
                    title: '',
                    content: '',
                    youtube_url: '',
                    notification_type: 'news',
                    visibility: 'public',
                    priority: 0,
                    is_active: true
                };
            },

            submitForm ( e )
            {
                // Ensure editor content is synced if currently on text tab
                if ( this.activeTab === 'text' )
                {
                    this.form.content = this.$refs.editor.innerHTML;
                    this.form.youtube_url = ''; // Clear video if submitting text
                } else
                {
                    this.form.content = ''; // Clear text if submitting video
                }

                e.target.submit();
            }
        };
    }
</script>
{% endblock %}